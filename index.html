<style>
    body {
        margin: 0;
    }
</style>
<script src="gifuct-js.js"></script>
<script>
    let divider = 2;
    let fileInput;
    let nameInput;

    let frames;
    let backgroundColor;
    let duration = 0;
    let time = 0;
    let f = 0;
    let canvas;
    let context;
    let tempCanvas;
    let tempContext;
    let options = {}
    let lastDisposalType = 2;

    const keyframes = [];
    let gradients;

    function render() {
        const frame = frames[f];
        const dims = frame.dims;
	
        if (!canvas) {
            canvas = document.createElement('canvas');
            context = canvas.getContext('2d');
            canvas.width = dims.width;
            canvas.height = dims.height;

            tempCanvas = document.createElement('canvas');
            tempContext = tempCanvas.getContext('2d');
            tempCanvas.width = dims.width;
            tempCanvas.height = dims.height;
        }

        if (lastDisposalType == 2) {
            if (backgroundColor) {
                context.fillStyle = backgroundColor;
                context.fillRect(0, 0, canvas.width, canvas.height);
            }
            else {
                context.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
	
        const imageData = tempContext.createImageData(dims.width, dims.height);
        imageData.data.set(frame.patch);
        tempContext.putImageData(imageData, 0, 0);

        context.drawImage(tempCanvas, dims.left, dims.top);

        lastDisposalType = frame.disposalType;
    }

    function convert() {
        let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        gradients = [];

        for (let x = 0; x < canvas.width; x += divider) {
            const colors = [];

            for (let y = 0; y < canvas.height; y += divider) {
                let i = ((y * canvas.width) + x) * 4;

                let r = ('0'+imageData.data[i+0].toString(16)).slice(-2);
                let g = ('0'+imageData.data[i+1].toString(16)).slice(-2);
                let b = ('0'+imageData.data[i+2].toString(16)).slice(-2);
                let a = ('0'+imageData.data[i+3].toString(16)).slice(-2);

                if (options.reduceColors) {
                    r = r.slice(0, 1);
                    g = g.slice(0, 1);
                    b = b.slice(0, 1);
                    a = a.slice(0, 1);
                }

                let color = `#${r}${g}${b}`;

                if (options.transparency) {
                    color += a;
                }

                colors.push(color);
            }

            let gradient = `linear-gradient(${colors.join(',')})`;
            gradients.push(gradient);
        }

        let percent = ((time / duration) * 100).toFixed(2);

        let frameCss = percent+'%{background-image:'+gradients.join(',')+'}';
        keyframes.push(frameCss);
    }

    function encode() {
        options = {
            reduceColors: document.getElementById('reduce-colors-checkbox').checked,
            center: document.getElementById('center-checkbox').checked,
            transparency: document.getElementById('transparency-checkbox').checked,
            name: nameInput.value || 'gif2css-animation',
            selector: document.getElementById('selector-input').value || 'body',
            scalable: document.getElementById('scalable-checkbox').checked
        };

        duration = 0;
        time = 0;
        lastDisposalType = 2;

        frames.forEach((frame) => {
            duration += frame.delay;
        });

        frames.forEach((frame, ff) => {
            f = ff;

            render();
            convert();

            time += frame.delay;
        });

        let css = '';
        let columnWidth = (divider/(canvas.width-divider))*100;

        if (options.scalable) {
            css += `body {\nbackground-size: ${columnWidth*2}% 100%;\n`;
        }
        else {
            css += `${options.selector} {\nbackground-size: ${divider}px ${canvas.height}px;\n`;
        }

        const positions = [];
        for (let x = 0; x < canvas.width; x += divider) {
            if (options.scalable) {
                positions.push(`${(x/divider)*columnWidth}% 0%`);
            }
            else {
                if (options.center) {
                    positions.push(`calc(50% + ${x-(canvas.width/2)}px) center`);
                }
                else {
                    positions.push(`${x}px 0px`);
                }
            }
        }

        const seconds = (duration / 1000).toFixed(2);
        console.log(seconds, 'seconds');

        css += 'animation: ' + options.name + ' ' + seconds + 's linear infinite;\n';
        css += 'background-repeat: no-repeat;\n';
        css += 'background-image: ' + gradients.join(',') + ';\n';
        css += 'background-position: ' + positions.join(',') + ';\n}\n';

        css += ' @keyframes ' + options.name + ' {' + keyframes.join('\n') + '}';

        console.log(css.length / 1024 / 1024);

        const style = document.createElement('style');
        style.innerHTML = css;
        document.head.appendChild(style);
    }

    function loadGif(arrayBuffer) {
        const gif = new GIF(arrayBuffer);
        frames = gif.decompressFrames(true);

        const bgIndex = gif.raw.lsd.backgroundColorIndex;
        if (bgIndex == frames[0].transparentIndex) {
            backgroundColor = null;
        }
        else {
            const colors = frames[0].colorTable[bgIndex];
            backgroundColor = `rgb(${colors[0]}, ${colors[1]}, ${colors[2]})`;
        }

        console.log('bgcolor', backgroundColor);
        console.log(frames.length + ' frames');

        encode();
    }

    function loadFile(event) {
        const URL = window.URL || window.webkitURL;
        const file = this.files[0];

        if (file.type.indexOf('image/gif') != 0) {
            fileInput.value = null;
            alert('that doesn\'t look like a gif...');
            return;
        }

        if (!nameInput.value) {
            nameInput.value = file.name.split('.')[0].replace(/ /g, '-');
        }

        file.arrayBuffer().then(loadGif);
    }

    window.addEventListener('load', () => {
        fileInput = document.getElementById('file-input');
        nameInput = document.getElementById('name-input');

        fileInput.addEventListener('change', loadFile);

        /*const oReq = new XMLHttpRequest();
        oReq.open('GET', 'spongebob.gif', true);
        oReq.responseType = "arraybuffer";

        oReq.onload = function (oEvent) {
            const arrayBuffer = oReq.response;

            if (arrayBuffer) {
                loadGif(arrayBuffer);
            }
        };

        oReq.send(null);*/
    });
</script>
<input type="file" id="file-input" />
<div>
    <label for="reduce-colors-checkbox">reduce colors</label>
    <input type="checkbox" id="reduce-colors-checkbox" checked="true" /> ?
</div>
<div>
    <label for="center-checkbox">center</label>
    <input type="checkbox" id="center-checkbox" checked="true" /> ?
</div>
<div>
    <label for="transparency-checkbox">transparency</label>
    <input type="checkbox" id="transparency-checkbox" /> ?
</div>
<div>
    <label for="name-input">animation name</label>
    <input type="text" id="name-input" /> ?
</div>
<div>
    <label for="selector-input">css selector</label>
    <input type="text" id="selector-input" value="body" /> ?
</div>
<div>
    <label for="scalable-checkbox">scalable</label>
    <input type="checkbox" id="scalable-checkbox" checked="true" /> ?
</div>
